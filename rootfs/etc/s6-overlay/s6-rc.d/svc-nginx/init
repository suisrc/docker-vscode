#!/usr/bin/with-contenv bash
set -e

echo "init nginx config ..."
#########################################################################
# 处理证书配置
# ${HOME}/.vnc/self.pem不存在，新建自签证书
if [[ ! -f ${HOME}/.vnc/self.csr ]]; then
    # Create cert for KasmVNC
    echo "creating self-signed file to ${HOME}/.vnc/self.(csr/key)"
    mkdir -p ${HOME}/.vnc
    openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
    -keyout ${HOME}/.vnc/self.key \
    -out    ${HOME}/.vnc/self.csr \
    -subj "/C=CN/ST=LN/L=DL/O=None/OU=SCC/CN=*"
fi

#########################################################################
# 使用密码验证
PASSWORD_PATH="$HOME/.passwd"
if [[ -f $PASSWORD_PATH ]]; then
    echo -e "purging existing VNC password settings"
    rm -f $PASSWORD_PATH
fi
if [ ! -z ${PASSWORD+x} ]; then
    # openssl passwd -5 使用的是基于 SHA-256 的密码哈希算法
    random_str=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 10 | head -n 1)
    echo "user:$(openssl passwd -5 -salt $random_str $PASSWORD):ow" > $PASSWORD_PATH
    chmod 600 $PASSWORD_PATH
fi

#########################################################################
## NGX_VSCC_CONF
NGX_VSCC_CONF=/etc/nginx/conf.d/vscm.server.conf
NGX_VSCC_DEMO=/etc/nginx/demo/vscm.server.conf
if [ -f ${NGX_VSCC_CONF} ]; then
  echo "[nginx] vscm.server.conf exists, skip"
elif [ ! -f ${NGX_VSCC_DEMO} ]; then
  echo "[nginx] vscm.server.conf demo not exists, skip"
else
  echo "[nginx] vscm.server.conf create ..."
  cp -f ${NGX_VSCC_DEMO} ${NGX_VSCC_CONF}
  # 使用密码验证
  if [ ! -z ${PASSWORD+x} ]; then
    sed -i 's/##//g' ${NGX_VSCC_CONF}
  fi
fi

#########################################################################
## NGX_KASM_CONF
NGX_KASM_CONF=/etc/nginx/conf.d/kasm.server.conf
NGX_KASM_DEMO=/etc/nginx/demo/kasm.server.conf
if [ -f ${NGX_KASM_CONF} ]; then
  echo "[nginx] kasm.server.conf exists, skip"
elif [ ! -f ${NGX_KASM_DEMO} ]; then
  echo "[nginx] kasm.server.conf demo not exists, skip"
else
  echo "[nginx] kasm.server.conf create ..."
  cp -f ${NGX_KASM_DEMO} ${NGX_KASM_CONF}
  # 使用密码验证
  if [ ! -z ${PASSWORD+x} ]; then
    sed -i 's/##//g' ${NGX_KASM_CONF}
  fi
fi
